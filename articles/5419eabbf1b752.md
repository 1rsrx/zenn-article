---
title: "ä»Šæ›´ãªãŒã‚‰APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’è‡ªä½œã—ã¦ã¿ã‚‹"
emoji: "ğŸ¾"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["swift"]
published: true
publication_name: "karabiner_inc"
---

# APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ä»•æ§˜
- é€šä¿¡çµæœã¯Resultå‹ã«ã—ã¦è¿”ã™
- Requestã‚¯ãƒ©ã‚¹ã§ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ, headeréƒ¨, Bodyéƒ¨ã‚’æŒ‡å®šã§ãã‚‹
- ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯ä½¿ç”¨ã—ãªã„

# å®Ÿè£…

## 1. Requestã‚¯ãƒ©ã‚¹ã®ä½œæˆ

### 1-1 Httpãƒ¡ã‚½ãƒƒãƒ‰ã®enumã‚’ç”¨æ„
```swift
enum HttpMethod: String {
    case get = "GET"
    case post = "POST"
    case put = "PUT"
    case delete = "DELETE"
    case patch = "PATCH"
}
```

### 1-2 ã‚¨ãƒ©ãƒ¼ç”¨ã®enumã‚’ç”¨æ„
```swift
enum ApiError: Error {
    case url
    case network
    case response
    case emptyResponse
    case parse
    case error(status: Int, data: Data)
}

extension ApiError: LocalizedError {
    var errorDescription: String? {
        switch self {
        case .url:
            return "URLãŒç„¡åŠ¹"
        case .network:
            return "ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æœªæ¥ç¶š"
        case .response:
            return "ãƒ¬ã‚¹ãƒãƒ³ã‚¹å–å¾—å¤±æ•—"
        case .emptyResponse:
            return "ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒç©º"
        case .parse:
            return "ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼"
        case .error(status: let status, data: let data):
            return "ã‚¨ãƒ©ãƒ¼ statusCode: \(status), data: \(data)"
        }
    }
}
```

### 1-3 Headerç”¨ã®ã‚¯ãƒ©ã‚¹ã‚’ç”¨æ„
```swift
class HttpHeader {
    private var header: [String: String]
    
    init(_ header: [String: String]) {
        self.header = header
    }
    
    func addValues(_ values: [String: String]) -> HttpHeader {
        var header = self.header
        
        values.forEach { (key, value) in
            header[key] = value
        }

        return HttpHeader(header)
    }
    
    func values() -> [String:String] {
        return self.header
    }
}
```
[String:String]ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã«å€¤ã‚’addValues()ã§è¿½åŠ ã™ã‚‹ãŸã‚ã«ä½œã‚Šã¾ã—ãŸã€‚
Dictionaryã‚’æ‹¡å¼µã—ã¦ã‚‚è‰¯ã‹ã£ãŸã®ã§ã™ãŒã€ã‚¹ã‚³ãƒ¼ãƒ—ãŒå¤§ãã„ã®ã§é¿ã‘ã¾ã—ãŸã€‚

### 1-4 ç©ºãƒ¬ã‚¹ãƒãƒ³ã‚¹ç”¨ã®æ§‹é€ ä½“ã‚’ç”¨æ„
```swift
struct EmptyResponse: Codable {}
```
QiitaAPIã‚’å©ãå°ã«ã—ã¦å‹•ä½œç¢ºèªã‚’è¡Œã£ãŸã¨ã“ã‚ã€DELETEãƒ¡ã‚½ãƒƒãƒ‰ã®æˆåŠŸæ™‚ã€ç©ºã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã£ã¦ãã‚‹ãŸã‚ãƒ‡ã‚³ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã—ãŸã€‚ç©ºãƒ¬ã‚¹ãƒãƒ³ã‚¹ã§ã‚‚ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã§çµæœãŒåˆ¤æ–­ã§ãã‚‹æ™‚ã¯ã“ã¡ã‚‰ã‚’Responseã«æŒ‡å®šã—ã¾ã™ã€‚

### 1-5 Protocolã®ç”¨æ„
```swift
protocol HttpRequestable {
    associatedtype Response: Decodable
    
    var baseURL: String { get }
    var path: String { get }
    var method: HttpMethod { get }
    var header: HttpHeader { get }
    var httpBody: Encodable? { get }
}
```
Requestç”¨ã®ã‚¯ãƒ©ã‚¹ã§ã“ã®ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’ç¶™æ‰¿ã—ã€å„å¤‰æ•°ã«å€¤ã‚’ã‚»ãƒƒãƒˆã—ã¾ã™ã€‚

### 1-6 Requestã®ä½œæˆ
```swift
struct QiitaApiPostArticleRequest: HttpRequestable {
    // ãƒ‡ã‚³ãƒ¼ãƒ‰ç”¨ã®ã‚¯ãƒ©ã‚¹ã‚’è¨­å®š
    typealias Response = QiitaApiPostArticleResponseJSON
    
    var baseURL: String {
        return AppConstant.Api.qiitaBaseURL
    }
    
    var path: String {
        return "items/"
    }
    
    var method: HttpMethod {
        return .post
    }
    
    var header: HttpHeader {
        return HttpHeader(ApiHeaderConstant.qiita)

        // å®šæ•°ãƒ˜ãƒƒãƒ€ãƒ¼ã«å€¤ã‚’è¿½åŠ ã™ã‚‹ã«ã¯ä¸‹è¨˜ã®ã‚ˆã†ã«ã—ã¾ã™ã€‚
        return HttpHeader(ApiHeaderConstant.qiita)
            .addValues([:])
            .addValues([:])
    }
    
    var httpBody: Encodable?
}
```

## 2. é€šä¿¡ã‚’è¡Œã†ã‚¯ãƒ©ã‚¹ä½œæˆã™ã‚‹
### ä»•æ§˜
- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ãŒ200å°ã®å ´åˆ
  - ãƒ‡ã‚³ãƒ¼ãƒ‰ã«æˆåŠŸ
    - æˆåŠŸã‚’è¿”ã™
  - ãƒ‡ã‚³ãƒ¼ãƒ‰ã«å¤±æ•—
    - ç©ºãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒæˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ™‚ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒç©ºã§ã‚ã‚Œã°ã€æˆåŠŸã‚’è¿”ã™
    - â†‘ã‚’æº€ãŸã•ãªã„å ´åˆã€å¤±æ•—ã‚’è¿”ã™
- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ãŒ200å°ä»¥å¤–ã®å ´åˆ
  - å¤±æ•—ã‚’è¿”ã™

```swift
class ApiClient {
    
    let session: URLSession
    
    init(session: URLSession) {
        self.session = session
    }
    
    func request<T: HttpRequestable>(
        _ request: T,
        completion: @escaping ((Result<T.Response, ApiError>) -> Void)
    ) {
        guard let url = URL(string: request.baseURL + request.path) else {
            completion(Result<T.Response, ApiError>.failure(.url))
            return
        }
        
        // å„ç¨®è¨­å®šã®ã‚»ãƒƒãƒˆ
        var urlRequest = URLRequest(url: url)
        urlRequest.httpMethod = request.method.rawValue
        urlRequest.allHTTPHeaderFields = request.header.values()
        if let httpBody = request.httpBody,
           let bodyData = try? JSONEncoder().encode(httpBody) {
            urlRequest.httpBody = bodyData
        }
        
        print("start \(urlRequest.httpMethod ?? "") \(urlRequest.url?.absoluteString ?? "")")
        let task = session.dataTask(with: urlRequest) { data, response, err in
            if let err = err {
                if let _ = err as? URLError {
                    completion(Result<T.Response, ApiError>.failure(.network))
                    return
                }
                
                completion(Result<T.Response, ApiError>.failure(.response))
                return
            }
            
            guard let response = response as? HTTPURLResponse,
                  let data = data else {
                completion(Result<T.Response, ApiError>.failure(.emptyResponse))
                return
            }
            
            // ãƒ­ã‚°
            let statusCode = response.statusCode
            print("ã‚¹ãƒ†ãƒ¼ãƒ†ã‚¹ã‚³ãƒ¼ãƒ‰: \(statusCode)")
            if let json = try? JSONSerialization.jsonObject(with: data) {
                print("ãƒ¬ã‚¹ãƒãƒ³ã‚¹: \(json)")
            }
            
            if (200...299).contains(statusCode) {
                // æˆåŠŸ
                do {
                    let object = try JSONDecoder().decode(T.Response.self, from: data)
                    completion(Result<T.Response, ApiError>.success(object))
                } catch {
                    // ç©ºãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒæˆåŠŸã®å ´åˆ
                    if String(data: data, encoding: .utf8) == "" {
                        if T.Response.self == EmptyResponse.self {
                            completion(Result<T.Response, ApiError>.success(EmptyResponse() as! T.Response))
                            return
                        }
                    }
                    
                    completion(Result<T.Response, ApiError>.failure(.parse))
                }
            } else {
                completion(Result<T.Response, ApiError>.failure(.error(status: statusCode, data: data)))
            }
        }
        
        task.resume()
    }
}
```


# ä½¿ã„æ–¹
```swift
class QiitaApiPostArticle {
    func execute(
        article: QiitaApiPostArticleRequestJSON,
        completion: @escaping ((Result<QiitaApiPostArticleResponseJSON, ApiError>) -> Void)
    ) {
        let request = QiitaApiPostArticleRequest(httpBody: article)
        ApiClient(session: URLSession.shared).request(request, completion: completion)
    }
}
```


```swift
let article = QiitaApiPostArticleRequestJSON(
            body: "æœ¬æ–‡",
            private: true,
            tags: [
                .init(name: "swift", versions: ["0.0.1"])
            ],
            title: "title",
            tweet: false
        )
let api = QiitaApiPostArticle()
api.execute(article: article) { result in
    switch result {
    case .success(let response):
        self.showAlert(title: "æˆåŠŸ", message: "\(response)")
    case .failure(let err):
        self.showAlert(title: "å¤±æ•—", message: "\(err)")
    }
}
```

# æœ€å¾Œã«
https://github.com/HikaruKurodq/ApiClientTest

æ–­ç‰‡çš„ã«ãªã£ã¦ã„ã‚‹ã®ã§ã€å…¨ä½“ãŒç¢ºèªã§ãã‚‹ã‚ˆã†ã«ãƒªãƒã‚¸ãƒˆãƒªã‚’ç”¨æ„ã—ã¾ã—ãŸã€‚
Combineç‰ˆã¨Concurrencyç‰ˆã‚‚ç”¨æ„ã—ã¦ã„ã¾ã™ã€‚

ãƒã‚µã‚«ãƒªæ­“è¿ãªã®ã§ã€è€ƒæ…®ä¸è¶³ãªç®‡æ‰€ã‚„é–“é•ã£ã¦ã„ã‚‹ç®‡æ‰€ãŒã‚ã‚Œã°ã€æ•™ãˆã¦ã„ãŸã ã‘ã‚‹ã¨å¬‰ã—ã„ã§ã™ã€‚