---
title: "ä»Šæ›´ãªãŒã‚‰APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’è‡ªä½œã—ã¦ã¿ã‚‹"
emoji: "ğŸ‘’"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["swift"]
published: true
---

# APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ä»•æ§˜
- é€šä¿¡çµæœã¯Resultå‹ã«ã—ã¦è¿”ã™
- Requestã‚¯ãƒ©ã‚¹ã§ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ, headeréƒ¨, Bodyéƒ¨ã‚’æŒ‡å®šã§ãã‚‹
- ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯ä½¿ç”¨ã—ãªã„

# å®Ÿè£…

## 1. Requestã‚¯ãƒ©ã‚¹ã®ä½œæˆ

### 1-1 Httpãƒ¡ã‚½ãƒƒãƒ‰ã®enumã‚’ç”¨æ„
```swift
enum HttpMethod: String {
    case get = "GET"
    case post = "POST"
    case put = "PUT"
    case delete = "DELETE"
    case patch = "PATCH"
}
```
### 1-2 ã‚¨ãƒ©ãƒ¼ç”¨ã®enumã‚’ç”¨æ„
```swift
enum ApiError: Error {
    case url // URLãŒç„¡åŠ¹
    
    // é€šä¿¡å¤±æ•—
    case network // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«ç¹‹ãŒã£ã¦ã„ãªã„
    case response // ãã‚Œä»¥å¤–

    // ãƒ¬ã‚¹ãƒãƒ³ã‚¹å–å¾—å¾Œ
    case emptyResponse // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒç©º
    case parse // JSONã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã«å¤±æ•—
    case errorResponse(status: Int, data: Decodable) // ãã®ä»–ï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒãƒ‡ã‚³ãƒ¼ãƒ‰ã§ããŸå ´åˆï¼‰
    case error(status: Int, data: Data) // ãã®ä»–ï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒãƒ‡ã‚³ãƒ¼ãƒ‰ã§ããªã„å ´åˆï¼‰
}
```

### 1-3 Headerç”¨ã®ã‚¯ãƒ©ã‚¹ã‚’ç”¨æ„
```swift
class HttpHeader {
    private var header: [String: String]
    
    init(_ header: [String: String]) {
        self.header = header
    }
    
    func addValues(_ values: [String: String]) -> HttpHeader {
        var header = self.header
        
        values.forEach { (key, value) in
            header[key] = value
        }

        return HttpHeader(header)
    }
    
    func values() -> [String:String] {
        return self.header
    }
}
```
[String:String]ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã«å€¤ã‚’è¿½åŠ ã™ã‚‹ãŸã‚ã«ä½œã‚Šã¾ã—ãŸã€‚
Dictionaryã‚’æ‹¡å¼µã—ã¦ã‚‚è‰¯ã‹ã£ãŸã®ã§ã™ãŒã€ã‚¹ã‚³ãƒ¼ãƒ—ãŒå¤§ãã„ã®ã§é¿ã‘ã¾ã—ãŸã€‚

### 1-4 Protocolã®ç”¨æ„
```swift
protocol HttpRequestable {
    associatedtype Response: Decodable
    associatedtype ErrorResponse: Decodable
    
    var baseURL: String { get }
    var path: String { get }
    var method: HttpMethod { get }
    var header: HttpHeader { get }
    var httpBody: Encodable? { get }
}
```

### 1-5 ç©ºãƒ¬ã‚¹ãƒãƒ³ã‚¹ç”¨ã®æ§‹é€ ä½“ã‚’ç”¨æ„
```swift
struct EmptyResponse: Codable {}
```
QiitaAPIã‚’å©ãå°ã«ã—ã¦å‹•ä½œç¢ºèªã‚’è¡Œã£ãŸã¨ã“ã‚ã€DELETEãƒ¡ã‚½ãƒƒãƒ‰ã®æˆåŠŸæ™‚ã€ç©ºã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã£ã¦ãã‚‹ãŸã‚ãƒ‡ã‚³ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã—ãŸã€‚ç©ºãƒ¬ã‚¹ãƒãƒ³ã‚¹ã§ã‚‚ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã§çµæœãŒåˆ¤æ–­ã§ãã‚‹æ™‚ã¯ã“ã¡ã‚‰ã‚’Responseã«æŒ‡å®šã—ã¾ã™ã€‚


## 2. é€šä¿¡ã‚’è¡Œã†ã‚¯ãƒ©ã‚¹ä½œæˆã™ã‚‹
### 2-1 ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ç‰ˆã®å®Ÿè£…
```swift
class ApiClient {
    
    func request<T: HttpRequestable>(
        _ request: T,
        completion: @escaping ((Result<T.Response, ApiError>) -> Void)
    ) {
        guard let url = URL(string: request.baseURL + request.path) else {
            completion(Result<T.Response, ApiError>.failure(.url))
            return
        }
        
        // ãƒ˜ãƒƒãƒ€ãƒ¼, HTTPãƒ¡ã‚½ãƒƒãƒ‰ã®è¨­å®š
        var urlRequest = URLRequest(url: url)
        urlRequest.httpMethod = request.method.rawValue
        urlRequest.allHTTPHeaderFields = request.header.values()
        
        // ãƒœãƒ‡ã‚£ãƒ¼éƒ¨ãŒã‚ã‚Œã°è¨­å®š
        if let httpBody = request.httpBody,
        let bodyData = try? JSONEncoder().encode(httpBody) {
            urlRequest.httpBody = bodyData
        }
        
        print("start \(urlRequest.httpMethod ?? "") \(urlRequest.url?.absoluteString ?? "")")
        let task = URLSession.shared.dataTask(with: urlRequest) { data, response, err in
            if let err = err {
                // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼
                if let _ = err as? URLError {
                    completion(Result<T.Response, ApiError>.failure(.network))
                    return
                }
                
                completion(Result<T.Response, ApiError>.failure(.response))
                return
            }

            guard let response = response as? HTTPURLResponse,
                  let data = data else {
                 // data, responseãŒç©ºã®å ´åˆ
                completion(Result<T.Response, ApiError>.failure(.emptyResponse))
                return
            }
            
            // ãƒ­ã‚°
            let statusCode = response.statusCode
            print("ã‚¹ãƒ†ãƒ¼ãƒ†ã‚¹ã‚³ãƒ¼ãƒ‰: \(statusCode)")
            if let json = try? JSONSerialization.jsonObject(with: data) {
                print("ãƒ¬ã‚¹ãƒãƒ³ã‚¹: \(json)")
            }
            
            if (200...299).contains(statusCode) {
                // æˆåŠŸ
                do {
                    let object = try JSONDecoder().decode(T.Response.self, from: data)
                    completion(Result<T.Response, ApiError>.success(object))
                } catch {
                    // ç©ºãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒæˆåŠŸã®å ´åˆ
                    if String(data: data, encoding: .utf8) == "" {
                        if let emptyResponse = EmptyResponse() as? T.Response {
                            completion(Result<T.Response, ApiError>.success(emptyResponse))
                            return
                        }
                    }

                    // ãƒ‡ã‚³ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼
                    completion(Result<T.Response, ApiError>.failure(.parse))
                }
            } else {
                // å¤±æ•—
                do {
                    // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ã§ããŸå ´åˆ
                    let object = try JSONDecoder().decode(T.ErrorResponse.self, from: data)
                    completion(Result<T.Response, ApiError>.failure(.errorResponse(status: statusCode, data: object)))
                } catch {
                    // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ã§ããªã‹ã£ãŸå ´åˆ
                    completion(Result<T.Response, ApiError>.failure(.error(status: statusCode, data: data)))
                }
            }
        }
        
        task.resume()
    }
}
```

èª¬æ˜ã¯ã‚³ãƒ¡ãƒ³ãƒˆã«æ›¸ãã¾ã—ãŸã€‚

### 2-2 Combine, Concurrencyå¯¾å¿œ
```swift
func request<T: HttpRequestable>(
    _ request: T
) -> AnyPublisher<Result<T.Response, ApiError>, Never> {
    return Future { promise in
        self.request(request) { result in
            promise(.success(result))
        }
    }
    .eraseToAnyPublisher()
}

func request<T: HttpRequestable>(
    _ request: T
) async -> Result<T.Response, ApiError> {
    return await withCheckedContinuation { continuation in
        self.request(request) { result in
            return continuation.resume(returning: result)
        }
    }
}
```

ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ç‰ˆã‚’ãƒ©ãƒƒãƒ—ã™ã‚‹å½¢ã§å®Ÿè£…ã—ã¾ã—ãŸã€‚
ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§1ã¤ã«çµ±ä¸€ã™ã‚‹å ´åˆã¯ã€ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ç‰ˆã‚’privateã«ã™ã‚‹ãªã‚Šã€ã„ã„æ„Ÿã˜ã«æ›¸ãæ›ãˆã¦ãã ã•ã„ï½—

## 3 Requestã®ä½œæˆ
```swift
class QiitaApiPostArticle {
    func execute(
        article: QiitaApiPostArticleRequestJSON,
        completion: @escaping ((Result<QiitaApiPostArticleResponseJSON, ApiError>) -> Void)
    ) {
        let request = QiitaApiPostArticleRequest(httpBody: article)
        ApiClient().request(request, completion: completion)
    }
}

struct QiitaApiPostArticleRequest: HttpRequestable {
    typealias Response = QiitaApiPostArticleResponseJSON
    typealias ErrorResponse = QiitaApiErrorResponse
    
    var baseURL: String {
        return AppConstant.Api.qiitaBaseURL
    }
    
    var path: String {
        return "items/"
    }
    
    var method: HttpMethod {
        return .post
    }
    
    var header: HttpHeader {
        return HttpHeader(ApiHeaderConstant.qiita)

        // å®šæ•°ãƒ˜ãƒƒãƒ€ãƒ¼ã«å€¤ã‚’è¿½åŠ ã™ã‚‹ã«ã¯ä¸‹è¨˜ã®ã‚ˆã†ã«ã—ã¾ã™ã€‚
        return HttpHeader(ApiHeaderConstant.qiita)
            .addValues([:])
            .addValues([:])
    }
    
    var httpBody: Encodable?
}
```

## å‘¼ã³å‡ºã—ã¦ã¿ã‚‹
### ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ç‰ˆ
```swift
let article = QiitaApiPostArticleRequestJSON(
            body: "æœ¬æ–‡",
            private: true,
            tags: [
                .init(name: "swift", versions: ["0.0.1"])
            ],
            title: "title",
            tweet: false
        )
let api = QiitaApiPostArticle()
api.execute(article: article) { result in
    switch result {
    case .success(let response):
        self.showAlert(title: "æˆåŠŸ", message: "\(response)")
    case .failure(let err):
        self.showAlert(title: "å¤±æ•—", message: "\(err)")
    }
}
```

### Combineç‰ˆ
```swift
let api = QiitaApiGetUserProfile()
api.execute()
    .sink { result in
        switch result {
        case .success(let response):
            self.showAlert(title: "æˆåŠŸ", message: "\(response)")
        case .failure(let err):
            self.showAlert(title: "å¤±æ•—", message: "\(err)")
        }
    }
    .store(in: &cancellables)
```

### Concurrencyç‰ˆ
```swift
let api = QiitaApiDeleteArticle()
Task {
    let result = await api.execute(itemID: "e3766591a506755a2d8d")
    
    switch result {
    case .success(let response):
        self.showAlert(title: "æˆåŠŸ", message: "\(response)")
    case .failure(let err):
        self.showAlert(title: "å¤±æ•—", message: "\(err)")
    }
}
```

## æœ€å¾Œã«
https://github.com/HikaruKurodq/ApiClientTest
ã“ã¡ã‚‰ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§å‹•ä½œç¢ºèªã§ãã¾ã™ã€‚

ãƒã‚µã‚«ãƒªæ­“è¿ãªã®ã§ã€è€ƒæ…®ä¸è¶³ãªç®‡æ‰€ã‚„é–“é•ã£ã¦ã„ã‚‹ç®‡æ‰€ãŒã‚ã‚Œã°ã€æ•™ãˆã¦ã„ãŸã ã‘ã‚‹ã¨å¬‰ã—ã„ã§ã™ã€‚